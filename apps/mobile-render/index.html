<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Appium UI Visual Debugger</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
    }
    #canvasContainer {
      position: relative;
      display: inline-block;
    }
    canvas {
      position: absolute;
      top: 0;
      left: 0;
    }
    #inspectorPanel {
      position: fixed;
      top: 10px;
      right: 10px;
      background: #f3f3f3;
      padding: 15px;
      border: 1px solid #ccc;
      width: 250px;
    }
    #controls {
      margin-bottom: 20px;
    }
    #highlightAllBtn {
      margin-top: 10px;
    }
  </style>
</head>
<body>

<div id="controls">
  <h2>Upload Appium Source and Screenshot</h2>
  <label>Upload XML Source:</label>
  <input type="file" id="sourceFile" accept=".xml"><br><br>
  <label>Upload Screenshot:</label>
  <input type="file" id="screenshotFile" accept="image/*"><br><br>
  <button id="debugButton">Load</button>
</div>

<div id="canvasContainer">
  <canvas id="screenshotCanvas" style="z-index: 0;"></canvas>
  <canvas id="bboxCanvas" style="z-index: 1;"></canvas>
  <canvas id="hoverCanvas" style="z-index: 2; pointer-events: auto;"></canvas>
</div>

<div id="inspectorPanel" style="display: none;">
  <button id="highlightAllBtn">Highlight All Elements</button>
  <p><strong>Hovered Element:</strong></p>
  <p id="hoverInfo">None</p>
</div>

<script>
let allElements = [];
let appResolution = { width: 390, height: 844 };

function parseXMLToElements(xmlText) {
  const parser = new DOMParser();
  const xmlDoc = parser.parseFromString(xmlText, 'application/xml');
  const isIOS = xmlDoc.querySelector('AppiumAUT') !== null;
  const tagRoot = isIOS ? 'AppiumAUT' : 'hierarchy';

  const root = xmlDoc.querySelector(tagRoot);
  const nodes = [...root.querySelectorAll('*')];

  return nodes.map(el => {
    let x = parseFloat(el.getAttribute('x'));
    let y = parseFloat(el.getAttribute('y'));
    let width = parseFloat(el.getAttribute('width'));
    let height = parseFloat(el.getAttribute('height'));
    let visible = (isIOS ? el.getAttribute('visible') : el.getAttribute('displayed')) === 'true';

    return { x, y, width, height, visible };
  }).filter(e => e.visible && !isNaN(e.x));
}

function loadScreenshotToCanvas(imageSrc, dimensions) {
  const canvas = document.getElementById('screenshotCanvas');
  const ctx = canvas.getContext('2d');
  const img = new Image();
  img.onload = function () {
    [canvas, ...['bboxCanvas', 'hoverCanvas'].map(id => document.getElementById(id))].forEach(c => {
      c.width = dimensions.width;
      c.height = dimensions.height;
    });
    ctx.drawImage(img, 0, 0, dimensions.width, dimensions.height);
  };
  img.src = imageSrc;
}

function drawAllBoundingBoxes(elements) {
  const ctx = document.getElementById('bboxCanvas').getContext('2d');
  ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
  ctx.strokeStyle = 'rgba(255,0,0,0.6)';
  ctx.lineWidth = 1;
  elements.forEach(({ x, y, width, height }) => {
    ctx.strokeRect(x, y, width, height);
  });
}

function enableHoverHighlight(elements) {
  const canvas = document.getElementById('hoverCanvas');
  const ctx = canvas.getContext('2d');

  canvas.onmousemove = (e) => {
    const rect = canvas.getBoundingClientRect();
    const mouseX = e.clientX - rect.left;
    const mouseY = e.clientY - rect.top;
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    for (const el of elements) {
      if (
        mouseX >= el.x && mouseX <= el.x + el.width &&
        mouseY >= el.y && mouseY <= el.y + el.height
      ) {
        ctx.strokeStyle = 'rgba(0, 128, 255, 0.8)';
        ctx.lineWidth = 2;
        ctx.strokeRect(el.x, el.y, el.width, el.height);
        document.getElementById('hoverInfo').innerText =
          `x: ${el.x}, y: ${el.y}, w: ${el.width}, h: ${el.height}`;
      }
    }
    document.getElementById('hoverInfo').innerText+=
          '\n'+`x: ${mouseX}, y: ${mouseY}`;
  };
}

document.getElementById('debugButton').onclick = () => {
  const sourceFile = document.getElementById('sourceFile').files[0];
  const screenshotFile = document.getElementById('screenshotFile').files[0];

  if (!sourceFile || !screenshotFile) {
    alert('Upload both XML and Screenshot.');
    return;
  }

  const reader = new FileReader();
  reader.onload = function (e) {
    const xmlText = e.target.result;
    allElements = parseXMLToElements(xmlText);

    const imgReader = new FileReader();
    imgReader.onload = function (imgEvent) {
      const imageSrc = imgEvent.target.result;
      appResolution = {
        width: Math.max(...allElements.map(e => e.x + e.width), 390),
        height: Math.max(...allElements.map(e => e.y + e.height), 844)
      };
      loadScreenshotToCanvas(imageSrc, appResolution);
      enableHoverHighlight(allElements);
      document.getElementById('inspectorPanel').style.display = 'block';
    };
    imgReader.readAsDataURL(screenshotFile);
  };
  reader.readAsText(sourceFile);
  document.getElementById('controls').style.display = 'none';
};

let isHighlighting = false;

document.getElementById('highlightAllBtn').onclick = () => {
  const ctx = document.getElementById('bboxCanvas').getContext('2d');
  isHighlighting = !isHighlighting;

  if (isHighlighting) {
    drawAllBoundingBoxes(allElements);
    document.getElementById('highlightAllBtn').innerText = 'Turn Off All Element Highlighting';
  } else {
    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
    document.getElementById('highlightAllBtn').innerText = 'Highlight All Elements';
  }
};


</script>

</body>
</html>
